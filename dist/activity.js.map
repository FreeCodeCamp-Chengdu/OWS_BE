{"version":3,"sources":["../source/activity.js"],"names":["Activity","LC","Object","extend","fetching","update","context","assign","Error","code","list","Query","greaterThanOrEqualTo","Date","limit","find","map","item","toJSON","query","interval","data","objectId","createWithoutData","link","createdAt","updatedAt","save","user","currentUser","error","search","keywords","page","rows","from","to","isNaN","lessThanOrEqualTo","body","addDescending","skip"],"mappings":";;;;;;;;;;;;AAAA;;AAEA;;AAEA;;AAEA,MAAMA,QAAQ,GAAGC,oBAAGC,MAAH,CAAUC,MAAV,CAAiB,UAAjB,CAAjB;;AAEA,IAAIC,QAAJ;;AAEO,eAAeC,MAAf,CAAsBC,OAAtB,EAA+B;AAClC,MAAIF,QAAJ,EACI,MAAMF,MAAM,CAACK,MAAP,CAAc,IAAIC,KAAJ,CAAU,oBAAV,CAAd,EAA+C;AAAEC,IAAAA,IAAI,EAAE;AAAR,GAA/C,CAAN;AAEJL,EAAAA,QAAQ,GAAG,CAAX;AAEA,QAAMM,IAAI,GAAG,CAAC,MAAM,IAAIT,oBAAGU,KAAP,CAAa,UAAb,EACfC,oBADe,CACM,OADN,EACe,IAAIC,IAAJ,EADf,EAEfC,KAFe,CAET,IAFS,EAGfC,IAHe,EAAP,EAGAC,GAHA,CAGIC,IAAI,IAAIA,IAAI,CAACC,MAAL,EAHZ,CAAb;;AAKA,MAAI;AAAA;AAAA;;AAAA;;AAAA;AACA,wDAAuB,uBAAaR,IAAb,EAAmBJ,OAAO,CAACa,KAAR,CAAcC,QAAjC,CAAvB,oLAAmE;AAAA,YAApDH,IAAoD;AAC/D,cAAMI,IAAI,GAAGJ,IAAI,CAACK,QAAL,GACPrB,oBAAGC,MAAH,CAAUqB,iBAAV,CAA4B,UAA5B,EAAwCN,IAAI,CAACK,QAA7C,CADO,GAEP,IAAItB,QAAJ,EAFN;AAIAiB,QAAAA,IAAI,CAACO,IAAL,GAAYP,IAAI,CAACO,IAAL,GAAY,EAAxB;AACA,eAAOP,IAAI,CAACK,QAAZ;AACA,eAAOL,IAAI,CAACQ,SAAZ;AACA,eAAOR,IAAI,CAACS,SAAZ;AAEA,cAAML,IAAI,CAACM,IAAL,CAAUV,IAAV,EAAgB;AAAEW,UAAAA,IAAI,EAAEtB,OAAO,CAACuB;AAAhB,SAAhB,CAAN;AACH;AAZD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAaH,GAbD,CAaE,OAAOC,KAAP,EAAc;AACZ1B,IAAAA,QAAQ,GAAG,CAAX;AAEA,UAAM0B,KAAN;AACH;;AAED1B,EAAAA,QAAQ,GAAG,CAAX;AACH;;AAEM,eAAe2B,MAAf,CAAsBzB,OAAtB,EAA+B;AAClC,MAAI;AAAE0B,IAAAA,QAAF;AAAYC,IAAAA,IAAI,GAAG,CAAnB;AAAsBC,IAAAA,IAAI,GAAG,EAA7B;AAAiCC,IAAAA,IAAjC;AAAuCC,IAAAA;AAAvC,MAA8C9B,OAAO,CAACa,KAA1D;AAECgB,EAAAA,IAAI,GAAG,IAAItB,IAAJ,CAASsB,IAAT,CAAR,EAA0BC,EAAE,GAAG,IAAIvB,IAAJ,CAASuB,EAAT,CAA/B;AAEA,QAAMjB,KAAK,GAAGa,QAAQ,GAChB,0BAAY,UAAZ,EAAwB,CAAC,OAAD,EAAU,SAAV,CAAxB,EAA8CA,QAA9C,CADgB,GAEhB,IAAI/B,oBAAGU,KAAP,CAAa,UAAb,CAFN;AAIA,MAAI,CAAC0B,KAAK,CAAC,CAACF,IAAF,CAAV,EAAmBhB,KAAK,CAACP,oBAAN,CAA2B,OAA3B,EAAoCuB,IAApC;AAEnB,MAAI,CAACE,KAAK,CAAC,CAACD,EAAF,CAAV,EAAiBjB,KAAK,CAACmB,iBAAN,CAAwB,OAAxB,EAAiCF,EAAjC;AAEjB9B,EAAAA,OAAO,CAACiC,IAAR,GAAe,MAAMpB,KAAK,CACrBqB,aADgB,CACF,OADE,EAEhBA,aAFgB,CAEF,KAFE,EAGhB1B,KAHgB,CAGVoB,IAHU,EAIhBO,IAJgB,CAIX,CAACR,IAAI,GAAG,CAAR,IAAaC,IAJF,EAKhBnB,IALgB,EAArB;AAMH","sourcesContent":["import LC from 'leanengine';\n\nimport updateEvents from '@fcc-cdc/it-events';\n\nimport { searchQuery } from './utility';\n\nconst Activity = LC.Object.extend('Activity');\n\nvar fetching;\n\nexport async function update(context) {\n    if (fetching)\n        throw Object.assign(new Error('Crawler is running'), { code: 400 });\n\n    fetching = 1;\n\n    const list = (await new LC.Query('Activity')\n        .greaterThanOrEqualTo('start', new Date())\n        .limit(1000)\n        .find()).map(item => item.toJSON());\n\n    try {\n        for await (let item of updateEvents(list, context.query.interval)) {\n            const data = item.objectId\n                ? LC.Object.createWithoutData('Activity', item.objectId)\n                : new Activity();\n\n            item.link = item.link + '';\n            delete item.objectId;\n            delete item.createdAt;\n            delete item.updatedAt;\n\n            await data.save(item, { user: context.currentUser });\n        }\n    } catch (error) {\n        fetching = 0;\n\n        throw error;\n    }\n\n    fetching = 0;\n}\n\nexport async function search(context) {\n    var { keywords, page = 1, rows = 10, from, to } = context.query;\n\n    (from = new Date(from)), (to = new Date(to));\n\n    const query = keywords\n        ? searchQuery('Activity', ['title', 'address'], keywords)\n        : new LC.Query('Activity');\n\n    if (!isNaN(+from)) query.greaterThanOrEqualTo('start', from);\n\n    if (!isNaN(+to)) query.lessThanOrEqualTo('start', to);\n\n    context.body = await query\n        .addDescending('start')\n        .addDescending('end')\n        .limit(rows)\n        .skip((page - 1) * rows)\n        .find();\n}\n"],"file":"activity.js"}