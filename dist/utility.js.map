{"version":3,"sources":["../source/utility.js"],"names":["count","list","cache","forEach","key","value","group","hash","JSON","stringify","Object","values","map","sum","reduce","item","percent","toFixed","flat","request","URI","errorHandler","options","response","status","error","assign","URIError","statusText","code","body","json","error_description","valueOf","field","input","querySelector","Array","from","filter","Boolean","querySelectorAll","requireSession","middleware","errorRedirect","redirectSeconds","context","parameter","currentUser","apply","concat","URL","href","searchQuery","table","keys","words","LC","Query","or","split","word","contains","updateRecord","data","record","join","first","extend","save"],"mappings":";;;;;;;;;;;;;;;;;AAAA;;AAEA;;AAEA;;AAEA;;;;;AAKO,SAASA,KAAT,CAAeC,IAAf,EAAqB;AACxB,QAAMC,KAAK,GAAG,EAAd;AAEAD,EAAAA,IAAI,CAACE,OAAL,CAAa,CAAC,CAACC,GAAD,EAAMC,KAAN,CAAD,KAAkB;AAC3B,UAAMC,KAAK,GAAIJ,KAAK,CAACE,GAAD,CAAL,GAAaF,KAAK,CAACE,GAAD,CAAL,IAAc,EAA1C;AAAA,UACIG,IAAI,GAAG,OAAOF,KAAP,KAAiB,QAAjB,GAA4BG,IAAI,CAACC,SAAL,CAAeJ,KAAf,CAA5B,GAAoDA,KAD/D;AAGAC,IAAAA,KAAK,CAACC,IAAD,CAAL,GAAcD,KAAK,CAACC,IAAD,CAAL,IAAe;AAAEH,MAAAA,GAAF;AAAOC,MAAAA,KAAP;AAAcL,MAAAA,KAAK,EAAE;AAArB,KAA7B;AAEAM,IAAAA,KAAK,CAACC,IAAD,CAAL,CAAYP,KAAZ;AACH,GAPD;AASA,SAAOU,MAAM,CAACC,MAAP,CAAcT,KAAd,EACFU,GADE,CACEN,KAAK,IAAI;AACVA,IAAAA,KAAK,GAAGI,MAAM,CAACC,MAAP,CAAcL,KAAd,CAAR;AAEA,UAAMO,GAAG,GAAGP,KAAK,CAACQ,MAAN,CAAa,CAACD,GAAD,EAAM;AAAEb,MAAAA;AAAF,KAAN,KAAoBa,GAAG,GAAGb,KAAvC,EAA8C,CAA9C,CAAZ;AAEA,WAAOM,KAAK,CAACM,GAAN,CAAUG,IAAI,IAAI;AACrBA,MAAAA,IAAI,CAACC,OAAL,GAAe,CAAC,CAAED,IAAI,CAACf,KAAL,GAAaa,GAAd,GAAqB,GAAtB,EAA2BI,OAA3B,CAAmC,CAAnC,CAAhB;AAEA,aAAOF,IAAP;AACH,KAJM,CAAP;AAKH,GAXE,EAYFG,IAZE,EAAP;AAaH;AAED;;;;;;;;;;;AASO,eAAeC,OAAf,CAAuBC,GAAvB,EAA4B,OAA+B,EAA3D,EAA+D;AAAA,MAAnC;AAAEC,IAAAA;AAAF,GAAmC;AAAA,MAAhBC,OAAgB;AAClE,QAAMC,QAAQ,GAAG,MAAM,wBAAMH,GAAN,EAAWE,OAAX,CAAvB;AAEA,MAAIC,QAAQ,CAACC,MAAT,GAAkB,GAAtB,EAA2B,OAAOD,QAAP;AAE3B,QAAME,KAAK,GAAGJ,YAAY,GACpB,MAAMA,YAAY,CAACE,QAAD,CADE,GAEpBb,MAAM,CAACgB,MAAP,CAAc,IAAIC,QAAJ,CAAaJ,QAAQ,CAACK,UAAtB,CAAd,EAAiD;AAC/CC,IAAAA,IAAI,EAAEN,QAAQ,CAACC;AADgC,GAAjD,CAFN;AAMAC,EAAAA,KAAK,CAACF,QAAN,GAAiBA,QAAjB;AAEA,QAAME,KAAN;AACH;AAED;;;;;;;;;AAOO,eAAeJ,YAAf,CAA4BE,QAA5B,EAAsC;AACzC,QAAMO,IAAI,GAAG,MAAMP,QAAQ,CAACQ,IAAT,EAAnB;AAEA,QAAMN,KAAK,GAAG,IAAIE,QAAJ,CAAaG,IAAI,CAACE,iBAAlB,CAAd;AAECP,EAAAA,KAAK,CAACI,IAAN,GAAaN,QAAQ,CAACC,MAAvB,EAAiCC,KAAK,CAACK,IAAN,GAAaA,IAA9C;AAEA,SAAOL,KAAP;AACH;AAED;;;;;;;AAKO,SAASQ,OAAT,CAAiBC,KAAjB,EAAwB;AAC3B,MAAIC,KAAK,GAAGD,KAAK,CAACE,aAAN,CACR,oEADQ,CAAZ;AAIA,MAAID,KAAJ,EAAW,OAAOA,KAAK,CAAC9B,KAAb;AAEX8B,EAAAA,KAAK,GAAGD,KAAK,CAACE,aAAN,CAAoB,cAApB,CAAR;AAEA,MAAID,KAAJ,EACI,OAAOE,KAAK,CAACC,IAAN,CAAWH,KAAK,CAACb,OAAjB,EAA0B,CAAC;AAAEjB,IAAAA;AAAF,GAAD,KAAeA,KAAzC,EAAgDkC,MAAhD,CAAuDC,OAAvD,CAAP;AAEJL,EAAAA,KAAK,GAAGD,KAAK,CAACO,gBAAN,CACJ,yDADI,CAAR;AAIA,MAAIN,KAAK,CAAC,CAAD,CAAT,EACI,OAAOE,KAAK,CAACC,IAAN,CAAWH,KAAX,EAAkB,CAAC;AAAE9B,IAAAA;AAAF,GAAD,KAAeA,KAAjC,EAAwCkC,MAAxC,CAA+CC,OAA/C,CAAP;AACP;AAED;;;;;;;;;AAOO,SAASE,cAAT,CACHC,UADG,EAEHC,aAAa,GAAG,GAFb,EAGHC,eAAe,GAAG,CAHf,EAIL;AACE,SAAO,UAASC,OAAT,EAAkB,GAAGC,SAArB,EAAgC;AACnC,QAAID,OAAO,CAACE,WAAZ,EACI,OAAOL,UAAU,CAACM,KAAX,CAAiB,IAAjB,EAAuB,CAACH,OAAD,EAAUI,MAAV,CAAiBH,SAAjB,CAAvB,CAAP;AAEJD,IAAAA,OAAO,CAACtB,MAAR,GAAiB,GAAjB;AAEAoB,IAAAA,aAAa,GAAG,IAAIO,QAAJ,CAAQP,aAAR,EAAuBE,OAAO,CAAC3B,OAAR,CAAgBiC,IAAvC,IAA+C,EAA/D;AAEAN,IAAAA,OAAO,CAAChB,IAAR,GAAgB;sCACce,eAAgB,SAAQD,aAAc;;;;;eAK7DA,aAAc,KAAIA,aAAc;YACnCC,eAAgB;KAPpB;AASH,GAjBD;AAkBH;AAED;;;;;;;;;AAOO,SAASQ,WAAT,CAAqBC,KAArB,EAA4BC,IAA5B,EAAkCC,KAAlC,EAAyC;AAC5C,SAAOC,oBAAGC,KAAH,CAASC,EAAT,CACH,GAAGH,KAAK,CACHI,KADF,CACQ,KADR,EAEEhD,GAFF,CAEMiD,IAAI,IACLN,IAAI,CAAC3C,GAAL,CAASR,GAAG,IAAI,IAAIqD,oBAAGC,KAAP,CAAaJ,KAAb,EAAoBQ,QAApB,CAA6B1D,GAA7B,EAAkCyD,IAAlC,CAAhB,CAHL,EAKE3C,IALF,EADA,CAAP;AAQH;AAED;;;;;;;;;AAOO,eAAe6C,YAAf,CAA4BT,KAA5B,EAAmCU,IAAnC,EAAyC1C,OAAzC,EAAkD;AACrD,MAAI2C,MAAM,GAAG,MAAMZ,WAAW,CAC1BC,KAD0B,EAE1B5C,MAAM,CAAC6C,IAAP,CAAYS,IAAZ,CAF0B,EAG1BtD,MAAM,CAACC,MAAP,CAAcqD,IAAd,EAAoBE,IAApB,CAAyB,GAAzB,CAH0B,CAAX,CAIjBC,KAJiB,EAAnB;AAMAF,EAAAA,MAAM,GAAGA,MAAM,IAAI,KAAKR,oBAAG/C,MAAH,CAAU0D,MAAV,CAAiBd,KAAjB,CAAL,GAAnB;AAEA,QAAMW,MAAM,CAACI,IAAP,CAAYL,IAAZ,EAAkB1C,OAAlB,CAAN;AAEA,SAAO2C,MAAP;AACH","sourcesContent":["import { URL } from 'url';\n\nimport fetch from 'node-fetch';\n\nimport LC from 'leanengine';\n\n/**\n * @param {Array[]} list - Key-Value pairs\n *\n * @return {Object[]} List of `key`, `value`, `count` & `percent`\n */\nexport function count(list) {\n    const cache = {};\n\n    list.forEach(([key, value]) => {\n        const group = (cache[key] = cache[key] || {}),\n            hash = typeof value === 'object' ? JSON.stringify(value) : value;\n\n        group[hash] = group[hash] || { key, value, count: 0 };\n\n        group[hash].count++;\n    });\n\n    return Object.values(cache)\n        .map(group => {\n            group = Object.values(group);\n\n            const sum = group.reduce((sum, { count }) => sum + count, 0);\n\n            return group.map(item => {\n                item.percent = +((item.count / sum) * 100).toFixed(2);\n\n                return item;\n            });\n        })\n        .flat();\n}\n\n/**\n * @param {String|URL}       URI\n * @param {Object}           [options={}]           - https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch#Parameters\n * @param {HTTPErrorHandler} [options.errorHandler]\n *\n * @return {Response} https://developer.mozilla.org/en-US/docs/Web/API/Response\n *\n * @throw {URIError} With a `response` property\n */\nexport async function request(URI, { errorHandler, ...options } = {}) {\n    const response = await fetch(URI, options);\n\n    if (response.status < 300) return response;\n\n    const error = errorHandler\n        ? await errorHandler(response)\n        : Object.assign(new URIError(response.statusText), {\n            code: response.status\n        });\n\n    error.response = response;\n\n    throw error;\n}\n\n/**\n * @typedef {Function} HTTPErrorHandler\n *\n * @param {Response} response\n *\n * @return {Error}\n */\nexport async function errorHandler(response) {\n    const body = await response.json();\n\n    const error = new URIError(body.error_description);\n\n    (error.code = response.status), (error.body = body);\n\n    return error;\n}\n\n/**\n * @param {HTMLElement} field\n *\n * @return {String|String[]}\n */\nexport function valueOf(field) {\n    var input = field.querySelector(\n        'input[name]:not([type=\"radio\"], [type=\"checkbox\"]), textarea[name]'\n    );\n\n    if (input) return input.value;\n\n    input = field.querySelector('select[name]');\n\n    if (input)\n        return Array.from(input.options, ({ value }) => value).filter(Boolean);\n\n    input = field.querySelectorAll(\n        'input[name][type=\"radio\"], input[name][type=\"checkbox\"]'\n    );\n\n    if (input[0])\n        return Array.from(input, ({ value }) => value).filter(Boolean);\n}\n\n/**\n * @param {Function}   middleware\n * @param {String|URL} [errorRedirect='/']\n * @param {Number}     [redirectSeconds=3]\n *\n * @return {Function}\n */\nexport function requireSession(\n    middleware,\n    errorRedirect = '/',\n    redirectSeconds = 3\n) {\n    return function(context, ...parameter) {\n        if (context.currentUser)\n            return middleware.apply(this, [context].concat(parameter));\n\n        context.status = 403;\n\n        errorRedirect = new URL(errorRedirect, context.request.href) + '';\n\n        context.body = `\n<meta http-equiv=\"refresh\" content=\"${redirectSeconds}; url=${errorRedirect}\">\n\n<h1>Signed session is required!</h1>\n<p>\n    It'll be redirected to\n    <a href=\"${errorRedirect}\">${errorRedirect}</a>\n    in <b>${redirectSeconds}</b> seconds\n</p>`;\n    };\n}\n\n/**\n * @param {String}   table\n * @param {String[]} keys\n * @param {String}   words\n *\n * @return {AV.Query} https://leancloud.github.io/javascript-sdk/docs/AV.Query.html\n */\nexport function searchQuery(table, keys, words) {\n    return LC.Query.or(\n        ...words\n            .split(/\\s+/)\n            .map(word =>\n                keys.map(key => new LC.Query(table).contains(key, word))\n            )\n            .flat()\n    );\n}\n\n/**\n * @param {String} table\n * @param {Object} data\n * @param {Object} [options] - https://leancloud.github.io/javascript-sdk/docs/global.html#AuthOptions\n *\n * @return {AV.Object} https://leancloud.github.io/javascript-sdk/docs/AV.Object.html\n */\nexport async function updateRecord(table, data, options) {\n    var record = await searchQuery(\n        table,\n        Object.keys(data),\n        Object.values(data).join(' ')\n    ).first();\n\n    record = record || new (LC.Object.extend(table))();\n\n    await record.save(data, options);\n\n    return record;\n}\n"],"file":"utility.js"}