{"version":3,"sources":["../../source/form/JinShuJu.js"],"names":["Form","LC","Object","extend","FormReply","parseForm","id","window","document","JSDOM","fromURL","source","name","querySelector","textContent","trim","description","innerHTML","fields","Array","from","querySelectorAll","item","fieldType","apiCode","label","dataset","key","type","replace","defaultValue","filter","Boolean","create","context","request","body","form","Query","equalTo","first","save","status","reply","entry","info_browser","info_os","info_remote_ip","serial_number","extra","meta","assign","URIError","code","get","data","user","field","find","email","mobilePhoneNumber","currentUser","useMasterKey","form_id","system","browser","IPA","query","entries","map","value"],"mappings":"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","sourcesContent":["import LC from 'leanengine';\n\nimport { JSDOM } from 'jsdom';\n\nimport { valueOf, updateRecord } from '../utility';\n\nconst Form = LC.Object.extend('Form'),\n    FormReply = LC.Object.extend('FormReply');\n\nasync function parseForm(id) {\n    const {\n        window: { document }\n    } = await JSDOM.fromURL('https://jinshuju.net/f/' + id);\n\n    return {\n        source: 'JinShuJu',\n        id,\n        name: document.querySelector('h1.form-title').textContent.trim(),\n        description: document\n            .querySelector('.form-description')\n            .innerHTML.trim(),\n        fields: Array.from(document.querySelectorAll('.field'), item => {\n            const { fieldType, apiCode, label } = item.dataset;\n\n            const description = item.querySelector('.field-description');\n\n            if (fieldType !== 'page-break')\n                for (let key in item.dataset)\n                    return {\n                        type: fieldType.replace(/-field$/, ''),\n                        key: apiCode,\n                        label,\n                        description:\n                            description && description.innerHTML.trim(),\n                        defaultValue: valueOf(item)\n                    };\n        }).filter(Boolean)\n    };\n}\n\nexport async function create(context) {\n    const { id } = context.request.body;\n\n    const form = await new LC.Query('Form').equalTo('id', id).first();\n\n    await (form || new Form()).save(await parseForm(id));\n\n    (context.status = 201), (context.body = '');\n}\n\nexport async function reply(context) {\n    const {\n        form,\n        entry: {\n            info_browser,\n            info_os,\n            info_remote_ip,\n            serial_number,\n            ...extra\n        }\n    } = context.request.body;\n\n    const meta = await new LC.Query('Form')\n        .equalTo('source', 'JinShuJu')\n        .equalTo('id', form)\n        .first();\n\n    if (!meta)\n        throw Object.assign(new URIError(form + ' not found'), {\n            code: 404\n        });\n\n    var fields = meta.get('fields'),\n        data = {},\n        user;\n\n    for (let key in extra) {\n        const field = fields.find(item => item.key === key);\n\n        if (field)\n            switch (field.type) {\n                case 'email':\n                    (user = user || {}), (user.email = extra[key]);\n                    continue;\n                case 'mobile':\n                    (user = user || {}), (user.mobilePhoneNumber = extra[key]);\n                    continue;\n                case 'telephone':\n                    continue;\n            }\n        data[key] = extra[key];\n    }\n\n    if (user)\n        user = await updateRecord('_User', user, {\n            user: context.currentUser,\n            useMasterKey: true\n        });\n\n    await new FormReply().save({\n        source: 'JinShuJu',\n        form: meta,\n        form_id: form,\n        id: serial_number,\n        system: info_os,\n        browser: info_browser,\n        IPA: info_remote_ip,\n        user,\n        data\n    });\n\n    (context.status = 201), (context.body = '');\n}\n\nexport function query(reply) {\n    var {\n        data,\n        form: { fields }\n    } = reply;\n\n    return {\n        ...reply,\n        data: Object.entries(data).map(([key, value]) => ({\n            key,\n            value,\n            ...fields.find(item => item.key === key || item.type === key)\n        }))\n    };\n}\n"],"file":"JinShuJu.js"}